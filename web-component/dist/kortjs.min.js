export default class kortjs extends HTMLElement{constructor(){const t=super(),e=(()=>{const e=t.dataset.url.replace("${id}",t.dataset.id).replace("${token}",t.dataset.token),o=t.dataset.tilesize?parseInt(t.dataset.tilesize):256,n=t.dataset.minzoom?parseInt(t.dataset.minzoom):0,i=t.dataset.maxzoom?parseInt(t.dataset.maxzoom):19,s=t.dataset.setLatitude?parseFloat(t.dataset.setLatitude):51.479263,a=t.dataset.setLongitude?parseFloat(t.dataset.setLongitude):0,r=Math.max(Math.min(t.dataset.setZoom?parseInt(t.dataset.setZoom):10,i),n);return{getURL:function([t,o,n]){return e.replace("${z}",t).replace("${x}",o).replace("${y}",n)},getTileSize:function(){return o},getCoordinatesAndZoom:function(){return[r,a,s]},getMinMaxZoom:function(){return[n,i]}}})(),o=t.attachShadow({mode:"open"}),n=document.createElement("div");n.setAttribute("class","viewport");const i=document.createElement("div");i.setAttribute("class","attribution-container"),i.setAttribute("part","attribution-container");const s=document.createElement("a");s.textContent="kortjs |",s.setAttribute("href","https://github.com/DLFDK/kortjs/"),s.setAttribute("target","_blank"),s.setAttribute("rel","noreferrer noopener");const a=document.createElement("slot");a.setAttribute("name","attribution-text"),i.append(s,a);const r=document.createElement("slot");r.setAttribute("name","attribution-icon");const l=document.createElement("slot");l.setAttribute("name","marker");const c=document.createElement("style");c.textContent=".viewport{box-sizing:border-box;position:relative;width:100%;height:100%;overflow:hidden;touch-action:none;user-select:none;cursor:grab;background:var(--kortjs-backgroundColor, #dddddd)}.layer{position:absolute;top:0;left:0}.hidden{opacity:0}.middle{z-index:1}.top{z-index:2}canvas{position:absolute}.attribution-container{position:absolute;bottom:0;right:0;z-index:3;display:flex;gap:4px;padding:2px 6px 6px 6px;background:rgba(255,255,255,.5);border-top-left-radius:4px;font-size:clamp(9px,2vw,13px);margin:0}::slotted(*){z-index:3}::slotted(p){margin:0}slot[name=marker]{display:none}.default-marker{position:absolute;z-index:3;width:48px;height:48px}",o.append(n,c),n.append(i,r,l);const d=(()=>{const t=new Set,o=new Worker(URL.createObjectURL(new Blob([`(${function(){onmessage=async({data:{topic:t,...e}})=>{if("fetch"===t){const{id:t,url:o,tileX:n,tileY:i}=e,s=await fetch(o).catch((t=>{console.log(t)}));if(s?.ok){const e=await s.blob(),o=await createImageBitmap(e);postMessage({id:t,bitmap:o,tileX:n,tileY:i},[o])}}}}.toString()})()`],{type:"text/javascript"})));return o.onmessage=function({data:{id:e,bitmap:o,tileX:n,tileY:i}}){t.delete(e),u.addTile(e,o,n,i)},{paint:function(n,i,s,a,r){const l=[],c=2**n.zoom;for(let d=0;d<r;d++)for(let r=0;r<a;r++){const a=`${n.zoom},${i+r+n.origin.tileX},${s+d+n.origin.tileY}`,u=((i+r+n.origin.tileX)%c+c)%c,m=((s+d+n.origin.tileY)%c+c)%c,p=e.getURL([n.zoom,u,m]);l.push(a),!n.isActive||n.tiles.has(a)||t.has(a)||(t.add(a),n.tiles.set(a),o.postMessage({topic:"fetch",id:a,url:p,tileX:i+r,tileY:s+d}))}const d=[...n.tiles.keys()].filter((t=>!l.includes(t)));for(const t of d){if(n.tiles.get(t)){const[e,o]=n.tiles.get(t);e&&(e.classList.add("hidden"),n.tileStorage.push([e,o]))}n.tiles.delete(t)}}}})(),u=(()=>{let{width:o,height:i}=n.getBoundingClientRect(),s=o/2,a=i/2;const r=e.getTileSize(),[c,u]=e.getMinMaxZoom(),m=[];let p,f;function g(t,e,o){const n=r*t.scale,i=e-s/n;t.origin.tileX=Math.floor(i);const l=i-t.origin.tileX,c=o-a/n;t.origin.tileY=Math.floor(c);const d=c-t.origin.tileY;t.position.x=Math.round(-l*n),t.position.y=Math.round(-d*n),h(t,0,0,{round:!1})}function h(t,e,o,n={}){const{round:i}=n;i?(t.position.x=Math.round(t.position.x+e),t.position.y=Math.round(t.position.y+o)):(t.position.x+=e,t.position.y+=o),t.element.style.transform=`translate3d(${t.position.x}px, ${t.position.y}px, 0px) scale(${t.scale})`}function x(t){for(const e of m)if(e.isActive||e.tiles.size){if(e.position.x=(e.position.x-s)*t+s,e.position.y=(e.position.y-a)*t+a,e.scale*=t,e.scale<.0625){v(e);continue}h(e,0,0,{round:!1})}}function b(t,e){if(f===m[0].zoom)return;const o=r*m[0].scale,n=(m[0].origin.tileX+(s-m[0].position.x)/o)*t,i=(m[0].origin.tileY+(a-m[0].position.y)/o)*t;v(m[2]),m[0].isActive=!1,m[0].element.classList.remove("top"),m[0].element.classList.add("middle"),m[1].element.classList.remove("middle"),m[2].element.classList.add("top"),m[2].zoom=f,m[2].scale=e,g(m[2],n,i),m[2].isActive=!0,m.unshift(m.pop()),A()}function v(t){if(t.tiles.size){for(const[e,o]of t.tiles)if(o){const[e,n]=o;e.classList.add("hidden"),t.tileStorage.push([e,n])}t.tiles.clear()}}function A(){for(const t of m)if(t.isActive||t.tiles.size){const[o,n,i,s]=e(t);if(t.lastZoom===t.zoom&&t.lastTileX===o&&t.lastTileY===n&&t.lastGridLengthX===i&&t.lastGridLengthY===s)continue;t.lastZoom=t.zoom,t.lastTileX=o,t.lastTileY=n,t.lastGridLengthX=i,t.lastGridLengthY=s,d.paint(t,o,n,i,s,{useWorker:!0})}function e(t){const e=r*t.scale,n=Math.floor(-(t.position.x+0)/e),s=Math.floor(-(t.position.y+0)/e),a=(-(t.position.x+0)%e+e)%e,l=(-(t.position.y+0)%e+e)%e;return[n,s,Math.ceil((a+o+0)/e),Math.ceil((l+i+0)/e)]}!function(){const{longitude:e,latitude:o}=function(){const t=2**m[0].zoom,e=r*m[0].scale,o=((m[0].origin.tileX+(s-m[0].position.x)/e)%t+t)%t,n=((m[0].origin.tileY+(a-m[0].position.y)/e)%t+t)%t,i=360*o/t-180,l=180*Math.atan(Math.sinh(Math.PI-2*Math.PI*n/t))/Math.PI;return{longitude:i,latitude:l}}();t.setAttribute("data-get-latitude",o),t.setAttribute("data-get-longitude",e),t.setAttribute("data-get-zoom",m[0].zoom)}()}return new ResizeObserver((()=>{console.log("Resizing!"),({width:o,height:i}=n.getBoundingClientRect()),s=o/2,a=i/2,p&&p(),A()})).observe(n),function(){!function(){for(let t=0;t<3;t++){const t=document.createElement("div");t.setAttribute("class","layer"),n.appendChild(t),m.push({tiles:new Map,tileStorage:[],scale:1,origin:{},position:{x:0,y:0},element:t,isActive:!1})}}();const[t,o,i]=e.getCoordinatesAndZoom();f=t,m[0].zoom=t,m[0].element.classList.add("top");const[s,a]=function(t,e){const o=2**m[0].zoom,n=o*(t+180)/360,i=o*(1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2;return[n,i]}(o,i);g(m[0],s,a),m[0].isActive=!0}(),function(){if(l.assignedNodes()[0]){const t=l.assignedNodes()[0].cloneNode("deep");t.setAttribute("class","default-marker"),n.append(t),p=()=>{const{width:e,height:o}=t.getBoundingClientRect(),n=t.dataset.offsetx?parseFloat(t.dataset.offsetx):-e/2,i=t.dataset.offsety?parseFloat(t.dataset.offsety):-o;t.style.transform=`translate3d(${s+n}px, ${a+i}px, 0px)`},p()}}(),A(),{move:function(t,e,o){h(m[0],t,e,{round:o});for(let n=1;n<m.length;n++)m[n].tiles.size&&h(m[n],t,e,{round:o});A()},pinch:function(t){m[0].isActive=!1;let e=m[0].scale*t;if(e>1&&m[0].zoom===u||e<1&&m[0].zoom===c)return;let o=t;if(e>=2&&m[0].zoom===u-1?o=2/m[0].scale:e<=.5&&m[0].zoom===c+1&&(o=.5/m[0].scale),x(o),m[0].scale>=2||m[0].scale<=.5){let t,e;m[0].scale>=2?(t=1,e=2):(t=-1,e=.5),f=m[0].zoom+t,b(e,m[0].scale/e)}else A()},addTile:function(t,o,n,i){if(m[0].tiles.has(t))if(m[0].tileStorage.length){const[e,s]=m[0].tileStorage.pop();e.classList.remove("hidden"),s.transferFromImageBitmap(o),e.style.transform=`translate3d(${n*r}px, ${i*r}px, 0px)`,m[0].tiles.set(t,[e,s]),e.animate({opacity:0,offset:0},{duration:300})}else{const s=document.createElement("canvas"),a=s.getContext("bitmaprenderer");s.width=e.getTileSize(),s.height=e.getTileSize(),m[0].element.appendChild(s),a.transferFromImageBitmap(o),s.style.transform=`translate3d(${n*r}px, ${i*r}px, 0px)`,m[0].tiles.set(t,[s,a]),s.animate({opacity:0,offset:0},{duration:300})}},getAbsoluteScale:function(){return m[0].scale},setAbsoluteScales:function(t){m[0].isActive=1===t,x(t/m[0].scale)},zoom:b,changeZoomLevel:function(t){const e=f+t;return!(e>u||e<c)&&(f+=t,!0)}}})();(()=>{const t=new Map;let e,o,i,s,a,r,l,c,d,m,p,f=[0,0,0];function g(e){t.has(e.pointerId)&&t.set(e.pointerId,[e.clientX,e.clientY])}function h(m){t.has(m.pointerId)&&(t.delete(m.pointerId),t.size?(cancelAnimationFrame(s),function(){cancelAnimationFrame(e);const t=u.getAbsoluteScale();let o;t<.75?(p=.5,o=-1):t>1.5?(p=2,o=1):(p=1,o=0);u.changeZoomLevel(o)&&A(t,250)}(),[a,r]=[...t.values()][0],l=0,c=0,o=requestAnimationFrame((t=>{x(t,performance.now(),0,0)}))):(n.style.cursor="grab",cancelAnimationFrame(o),document.removeEventListener("pointerup",h),document.removeEventListener("pointermove",g),Math.sqrt(l**2+c**2)>.2&&(d=performance.now(),i=requestAnimationFrame((t=>{b(t,d)})))))}function x(e,n,i,s){const d=e-n,[m,p]=[...t.values()][0],f=m-a,g=p-r,h=f-i,b=g-s;if(d>0){const t=1-Math.exp(-d/32);l=t*h/d+(1-t)*l,c=t*b/d+(1-t)*c}o=requestAnimationFrame((t=>{x(t,e,f,g)})),u.move(h,b,!0)}function b(t,e){const o=t-e,n=Math.exp(-(e-d)/2e3),s=n*l*o,a=n*c*o;let r=!0;n>.05&&(r=!1,i=requestAnimationFrame((e=>{b(e,t)}))),u.move(s,a,r)}function v(e,o){const[n,i]=[...t.values()],a=Math.sqrt((n[0]-i[0])**2+(n[1]-i[1])**2);u.pinch(a/o),s=requestAnimationFrame((t=>{v(t,a)}))}function A(t,o){function n(i,s,a){const r=i-s+a;if(r<o){const s=t+(p-t)*(1-(1-r/o)**3);u.setAbsoluteScales(s),e=requestAnimationFrame((t=>{n(t,i,r)}))}else m=!1,u.setAbsoluteScales(p),u.zoom(p,1)}cancelAnimationFrame(e),e=requestAnimationFrame((t=>{n(t,t,0)}))}n.addEventListener("pointerdown",(function(d){switch(t.size){case 0:n.style.cursor="grabbing",function(t){return Math.abs(f[0]-t.clientX)<50&&Math.abs(f[1]-t.clientY)<50&&Math.abs(f[2]-t.timeStamp)<250||(f=[t.clientX,t.clientY,t.timeStamp],!1)}(d)&&function(){const t=2;if(u.changeZoomLevel(1)){const e=u.getAbsoluteScale();m?p*=t:(m=!0,p=t),A(e,250)}}(),cancelAnimationFrame(i),t.set(d.pointerId,[d.clientX,d.clientY]),a=d.clientX,r=d.clientY,l=0,c=0,document.addEventListener("pointerup",h),document.addEventListener("pointermove",g),o=requestAnimationFrame((t=>{x(t,performance.now(),0,0)}));break;case 1:cancelAnimationFrame(e),cancelAnimationFrame(o),t.set(d.pointerId,[d.clientX,d.clientY]);const[b,z]=[...t.values()],M=Math.sqrt((b[0]-z[0])**2+(b[1]-z[1])**2);s=requestAnimationFrame((t=>{v(t,M)}))}})),n.addEventListener("wheel",(function(t){let e,o;t.preventDefault(),t.deltaY>0?(o=.5,e=-1):(o=2,e=1);if(u.changeZoomLevel(e)){const t=u.getAbsoluteScale();m?p*=o:(m=!0,p=o),A(t,250)}}),{passive:!1})})()}}customElements.define("kort-js",kortjs);